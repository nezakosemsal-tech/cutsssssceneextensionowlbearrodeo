var e=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var t=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},n=class{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error(`Unable to get user ID: not ready`);return this.messageBus.userId}getSelection(){return t(this,void 0,void 0,function*(){let{selection:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_SELECTION`,{});return e})}select(e,n){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_SELECT`,{items:e,replace:n})})}deselect(e){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_DESELECT`,{items:e})})}getName(){return t(this,void 0,void 0,function*(){let{name:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_NAME`,{});return e})}setName(e){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_SET_NAME`,{name:e})})}getColor(){return t(this,void 0,void 0,function*(){let{color:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_COLOR`,{});return e})}setColor(e){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_SET_COLOR`,{color:e})})}getSyncView(){return t(this,void 0,void 0,function*(){let{syncView:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_SYNC_VIEW`,{});return e})}setSyncView(e){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_SET_SYNC_VIEW`,{syncView:e})})}getId(){return t(this,void 0,void 0,function*(){let{id:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_ID`,{});return e})}getRole(){return t(this,void 0,void 0,function*(){let{role:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_ROLE`,{});return e})}getMetadata(){return t(this,void 0,void 0,function*(){let{metadata:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_METADATA`,{});return e})}setMetadata(e){return t(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_PLAYER_SET_METADATA`,{update:e})})}hasPermission(e){return t(this,void 0,void 0,function*(){if((yield this.getRole())===`GM`)return!0;let{permissions:t}=yield this.messageBus.sendAsync(`OBR_ROOM_GET_PERMISSIONS`,{});return t.indexOf(e)>-1})}getConnectionId(){return t(this,void 0,void 0,function*(){let{connectionId:e}=yield this.messageBus.sendAsync(`OBR_PLAYER_GET_CONNECTION_ID`,{});return e})}onChange(e){let t=t=>{e(t.player)};return this.messageBus.send(`OBR_PLAYER_SUBSCRIBE`,{}),this.messageBus.on(`OBR_PLAYER_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_PLAYER_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_PLAYER_EVENT_CHANGE`,t)}}},r=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},i=class{constructor(e){this.messageBus=e}reset(){return r(this,void 0,void 0,function*(){let{transform:e}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_RESET`,{});return e})}animateTo(e){return r(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_VIEWPORT_ANIMATE_TO`,{transform:e})})}animateToBounds(e){return r(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_VIEWPORT_ANIMATE_TO_BOUNDS`,{bounds:e})})}getPosition(){return r(this,void 0,void 0,function*(){let{position:e}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_GET_POSITION`,{});return e})}setPosition(e){return r(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_VIEWPORT_SET_POSITION`,{position:e})})}getScale(){return r(this,void 0,void 0,function*(){let{scale:e}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_GET_SCALE`,{});return e})}setScale(e){return r(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_VIEWPORT_SET_SCALE`,{scale:e})})}getWidth(){return r(this,void 0,void 0,function*(){let{width:e}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_GET_WIDTH`,{});return e})}getHeight(){return r(this,void 0,void 0,function*(){let{height:e}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_GET_HEIGHT`,{});return e})}transformPoint(e){return r(this,void 0,void 0,function*(){let{point:t}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_TRANSFORM_POINT`,{point:e});return t})}inverseTransformPoint(e){return r(this,void 0,void 0,function*(){let{point:t}=yield this.messageBus.sendAsync(`OBR_VIEWPORT_INVERSE_TRANSFORM_POINT`,{point:e});return t})}};function a(e){return typeof e.id==`string`}var o=e(((e,t)=>{var n=typeof Reflect==`object`?Reflect:null,r=n&&typeof n.apply==`function`?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},i=n&&typeof n.ownKeys==`function`?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};function a(e){console&&console.warn&&console.warn(e)}var o=Number.isNaN||function(e){return e!==e};function s(){s.init.call(this)}t.exports=s,t.exports.once=m,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var c=10;function l(e){if(typeof e!=`function`)throw TypeError(`The "listener" argument must be of type Function. Received type `+typeof e)}Object.defineProperty(s,`defaultMaxListeners`,{enumerable:!0,get:function(){return c},set:function(e){if(typeof e!=`number`||e<0||o(e))throw RangeError(`The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received `+e+`.`);c=e}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if(typeof e!=`number`||e<0||o(e))throw RangeError(`The value of "n" is out of range. It must be a non-negative number. Received `+e+`.`);return this._maxListeners=e,this};function u(e){return e._maxListeners===void 0?s.defaultMaxListeners:e._maxListeners}s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e===`error`,a=this._events;if(a!==void 0)i&&=a.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=Error(`Unhandled error.`+(o?` (`+o.message+`)`:``));throw s.context=o,s}var c=a[e];if(c===void 0)return!1;if(typeof c==`function`)r(c,this,t);else for(var l=c.length,u=ne(c,l),n=0;n<l;++n)r(u[n],this,t);return!0};function d(e,t,n,r){var i,o,s;if(l(n),o=e._events,o===void 0?(o=e._events=Object.create(null),e._eventsCount=0):(o.newListener!==void 0&&(e.emit(`newListener`,t,n.listener?n.listener:n),o=e._events),s=o[t]),s===void 0)s=o[t]=n,++e._eventsCount;else if(typeof s==`function`?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),i=u(e),i>0&&s.length>i&&!s.warned){s.warned=!0;var c=Error(`Possible EventEmitter memory leak detected. `+s.length+` `+String(t)+` listeners added. Use emitter.setMaxListeners() to increase limit`);c.name=`MaxListenersExceededWarning`,c.emitter=e,c.type=t,c.count=s.length,a(c)}return e}s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)};function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=f.bind(r);return i.listener=n,r.wrapFn=i,i}s.prototype.once=function(e,t){return l(t),this.on(e,p(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,p(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,a,o;if(l(t),r=this._events,r===void 0||(n=r[e],n===void 0))return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit(`removeListener`,e,n.listener||t));else if(typeof n!=`function`){for(i=-1,a=n.length-1;a>=0;a--)if(n[a]===t||n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;i===0?n.shift():re(n,i),n.length===1&&(r[e]=n[0]),r.removeListener!==void 0&&this.emit(`removeListener`,e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n=this._events,r;if(n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i=Object.keys(n),a;for(r=0;r<i.length;++r)a=i[r],a!==`removeListener`&&this.removeAllListeners(a);return this.removeAllListeners(`removeListener`),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t==`function`)this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function ee(e,t,n){var r=e._events;if(r===void 0)return[];var i=r[t];return i===void 0?[]:typeof i==`function`?n?[i.listener||i]:[i]:n?ie(i):ne(i,i.length)}s.prototype.listeners=function(e){return ee(this,e,!0)},s.prototype.rawListeners=function(e){return ee(this,e,!1)},s.listenerCount=function(e,t){return typeof e.listenerCount==`function`?e.listenerCount(t):te.call(e,t)},s.prototype.listenerCount=te;function te(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n==`function`)return 1;if(n!==void 0)return n.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]};function ne(e,t){for(var n=Array(t),r=0;r<t;++r)n[r]=e[r];return n}function re(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function ie(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function m(e,t){return new Promise(function(n,r){function i(n){e.removeListener(t,a),r(n)}function a(){typeof e.removeListener==`function`&&e.removeListener(`error`,i),n([].slice.call(arguments))}h(e,t,a,{once:!0}),t!==`error`&&ae(e,i,{once:!0})})}function ae(e,t,n){typeof e.on==`function`&&h(e,`error`,t,n)}function h(e,t,n,r){if(typeof e.on==`function`)r.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener==`function`)e.addEventListener(t,function i(a){r.once&&e.removeEventListener(t,i),n(a)});else throw TypeError(`The "emitter" argument must be of type EventEmitter. Received type `+typeof e)}})),s,c=new Uint8Array(16);function l(){if(!s&&(s=typeof crypto<`u`&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!s))throw Error(`crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported`);return s(c)}var u=[];for(let e=0;e<256;++e)u.push((e+256).toString(16).slice(1));function d(e,t=0){return u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+`-`+u[e[t+4]]+u[e[t+5]]+`-`+u[e[t+6]]+u[e[t+7]]+`-`+u[e[t+8]]+u[e[t+9]]+`-`+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]}var f={randomUUID:typeof crypto<`u`&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function p(e,t,n){if(f.randomUUID&&!t&&!e)return f.randomUUID();e||={};let r=e.random||(e.rng||l)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){n||=0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return d(r)}var ee=p,te=o(),ne=class extends te.EventEmitter{constructor(e,t){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=e=>{let t=e.data;if(e.origin===this.targetOrigin&&a(t)){if(t.id===`OBR_READY`){this.ready=!0;let e=t.data;this.ref=e.ref,this.userId=e.userId}this.emit(t.id,t.data)}},this.send=(e,t,n)=>{var r;if(!this.ref)throw Error(`Unable to send message: not ready`);(r=window.parent)==null||r.postMessage({id:e,data:t,ref:this.ref,nonce:n},this.targetOrigin)},this.sendAsync=(e,t,n=5e3)=>{let r=`_${ee()}`;return this.send(e,t,r),Promise.race([new Promise((t,n)=>{let i=this;function a(n){i.off(`${e}_RESPONSE${r}`,a),i.off(`${e}_ERROR${r}`,o),t(n)}function o(t){i.off(`${e}_RESPONSE${r}`,a),i.off(`${e}_ERROR${r}`,o),n(t)}this.on(`${e}_RESPONSE${r}`,a),this.on(`${e}_ERROR${r}`,o)}),...n>0?[new Promise((t,r)=>window.setTimeout(()=>r(Error(`Message ${e} took longer than ${n}ms to get a result`)),n))]:[]])},this.roomId=t,this.targetOrigin=e,window.addEventListener(`message`,this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener(`message`,this.handleMessage)}},re=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},ie=class{constructor(e){this.messageBus=e}show(e,t){return re(this,void 0,void 0,function*(){let{id:n}=yield this.messageBus.sendAsync(`OBR_NOTIFICATION_SHOW`,{message:e,variant:t});return n})}close(e){return re(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_NOTIFICATION_CLOSE`,{id:e})})}},m=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},ae=class{constructor(e){this.messageBus=e}getColor(){return m(this,void 0,void 0,function*(){let{color:e}=yield this.messageBus.sendAsync(`OBR_SCENE_FOG_GET_COLOR`,{});return e})}setColor(e){return m(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_FOG_SET_COLOR`,{color:e})})}getStrokeWidth(){return m(this,void 0,void 0,function*(){let{strokeWidth:e}=yield this.messageBus.sendAsync(`OBR_SCENE_FOG_GET_STROKE_WIDTH`,{});return e})}setStrokeWidth(e){return m(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_FOG_SET_STROKE_WIDTH`,{strokeWidth:e})})}getFilled(){return m(this,void 0,void 0,function*(){let{filled:e}=yield this.messageBus.sendAsync(`OBR_SCENE_FOG_GET_FILLED`,{});return e})}setFilled(e){return m(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_FOG_SET_FILLED`,{filled:e})})}onChange(e){let t=t=>{e(t.fog)};return this.messageBus.send(`OBR_SCENE_FOG_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_FOG_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_FOG_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_FOG_EVENT_CHANGE`,t)}}},h=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},oe=class{constructor(e){this.messageBus=e}getDpi(){return h(this,void 0,void 0,function*(){let{dpi:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_DPI`,{});return e})}getScale(){return h(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_SCALE`,{})})}setScale(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_SCALE`,{scale:e})})}getColor(){return h(this,void 0,void 0,function*(){let{color:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_COLOR`,{});return e})}setColor(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_COLOR`,{color:e})})}getOpacity(){return h(this,void 0,void 0,function*(){let{opacity:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_OPACITY`,{});return e})}setOpacity(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_OPACITY`,{opacity:e})})}getType(){return h(this,void 0,void 0,function*(){let{type:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_TYPE`,{});return e})}setType(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_TYPE`,{type:e})})}getLineType(){return h(this,void 0,void 0,function*(){let{lineType:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_LINE_TYPE`,{});return e})}setLineType(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_LINE_TYPE`,{lineType:e})})}getMeasurement(){return h(this,void 0,void 0,function*(){let{measurement:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_MEASUREMENT`,{});return e})}setMeasurement(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_MEASUREMENT`,{measurement:e})})}getLineWidth(){return h(this,void 0,void 0,function*(){let{lineWidth:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_LINE_WIDTH`,{});return e})}setLineWidth(e){return h(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SET_LINE_WIDTH`,{lineWidth:e})})}snapPosition(e,t,n,r){return h(this,void 0,void 0,function*(){let{position:i}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_SNAP_POSITION`,{position:e,snappingSensitivity:t,useCorners:n,useCenter:r});return i})}getDistance(e,t){return h(this,void 0,void 0,function*(){let{distance:n}=yield this.messageBus.sendAsync(`OBR_SCENE_GRID_GET_DISTANCE`,{from:e,to:t});return n})}onChange(e){let t=t=>{e(t.grid)};return this.messageBus.send(`OBR_SCENE_GRID_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_GRID_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_GRID_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_GRID_EVENT_CHANGE`,t)}}},g=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},se=class{constructor(e){this.messageBus=e}undo(){return g(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_HISTORY_UNDO`,{})})}redo(){return g(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_HISTORY_REDO`,{})})}canUndo(){return g(this,void 0,void 0,function*(){let{canUndo:e}=yield this.messageBus.sendAsync(`OBR_SCENE_HISTORY_CAN_UNDO`,{});return e})}canRedo(){return g(this,void 0,void 0,function*(){let{canRedo:e}=yield this.messageBus.sendAsync(`OBR_SCENE_HISTORY_CAN_REDO`,{});return e})}},ce=Symbol.for(`immer-nothing`),_=Symbol.for(`immer-draftable`),v=Symbol.for(`immer-state`);function y(e,...t){throw Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var b=Object.getPrototypeOf;function x(e){return!!e&&!!e[v]}function S(e){return e?de(e)||Array.isArray(e)||!!e[_]||!!e.constructor?.[_]||E(e)||D(e):!1}var le=Object.prototype.constructor.toString(),ue=new WeakMap;function de(e){if(!e||typeof e!=`object`)return!1;let t=Object.getPrototypeOf(e);if(t===null||t===Object.prototype)return!0;let n=Object.hasOwnProperty.call(t,`constructor`)&&t.constructor;if(n===Object)return!0;if(typeof n!=`function`)return!1;let r=ue.get(n);return r===void 0&&(r=Function.toString.call(n),ue.set(n,r)),r===le}function C(e,t,n=!0){w(e)===0?(n?Reflect.ownKeys(e):Object.keys(e)).forEach(n=>{t(n,e[n],e)}):e.forEach((n,r)=>t(r,n,e))}function w(e){let t=e[v];return t?t.type_:Array.isArray(e)?1:E(e)?2:D(e)?3:0}function T(e,t){return w(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function fe(e,t){return w(e)===2?e.get(t):e[t]}function pe(e,t,n){let r=w(e);r===2?e.set(t,n):r===3?e.add(n):e[t]=n}function me(e,t){return e===t?e!==0||1/e==1/t:e!==e&&t!==t}function E(e){return e instanceof Map}function D(e){return e instanceof Set}function O(e){return e.copy_||e.base_}function he(e,t){if(E(e))return new Map(e);if(D(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);let n=de(e);if(t===!0||t===`class_only`&&!n){let t=Object.getOwnPropertyDescriptors(e);delete t[v];let n=Reflect.ownKeys(t);for(let r=0;r<n.length;r++){let i=n[r],a=t[i];a.writable===!1&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(t[i]={configurable:!0,writable:!0,enumerable:a.enumerable,value:e[i]})}return Object.create(b(e),t)}else{let t=b(e);if(t!==null&&n)return{...e};let r=Object.create(t);return Object.assign(r,e)}}function ge(e,t=!1){return A(e)||x(e)||!S(e)?e:(w(e)>1&&Object.defineProperties(e,{set:k,add:k,clear:k,delete:k}),Object.freeze(e),t&&Object.values(e).forEach(e=>ge(e,!0)),e)}function _e(){y(2)}var k={value:_e};function A(e){return typeof e!=`object`||!e?!0:Object.isFrozen(e)}var ve={};function j(e){let t=ve[e];return t||y(0,e),t}function ye(e,t){ve[e]||(ve[e]=t)}var M;function be(){return M}function xe(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Se(e,t){t&&(j(`Patches`),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function Ce(e){we(e),e.drafts_.forEach(Ee),e.drafts_=null}function we(e){e===M&&(M=e.parent_)}function Te(e){return M=xe(M,e)}function Ee(e){let t=e[v];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function De(e,t){t.unfinalizedDrafts_=t.drafts_.length;let n=t.drafts_[0];return e!==void 0&&e!==n?(n[v].modified_&&(Ce(t),y(4)),S(e)&&(e=Oe(t,e),t.parent_||Ae(t,e)),t.patches_&&j(`Patches`).generateReplacementPatches_(n[v].base_,e,t.patches_,t.inversePatches_)):e=Oe(t,n,[]),Ce(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e===ce?void 0:e}function Oe(e,t,n){if(A(t))return t;let r=e.immer_.shouldUseStrictIteration(),i=t[v];if(!i)return C(t,(r,a)=>ke(e,i,t,r,a,n),r),t;if(i.scope_!==e)return t;if(!i.modified_)return Ae(e,i.base_,!0),i.base_;if(!i.finalized_){i.finalized_=!0,i.scope_.unfinalizedDrafts_--;let t=i.copy_,a=t,o=!1;i.type_===3&&(a=new Set(t),t.clear(),o=!0),C(a,(r,a)=>ke(e,i,t,r,a,n,o),r),Ae(e,t,!1),n&&e.patches_&&j(`Patches`).generatePatches_(i,n,e.patches_,e.inversePatches_)}return i.copy_}function ke(e,t,n,r,i,a,o){if(i==null||typeof i!=`object`&&!o)return;let s=A(i);if(!(s&&!o)){if(x(i)){let o=Oe(e,i,a&&t&&t.type_!==3&&!T(t.assigned_,r)?a.concat(r):void 0);if(pe(n,r,o),x(o))e.canAutoFreeze_=!1;else return}else o&&n.add(i);if(S(i)&&!s){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||t&&t.base_&&t.base_[r]===i&&s)return;Oe(e,i),(!t||!t.scope_.parent_)&&typeof r!=`symbol`&&(E(n)?n.has(r):Object.prototype.propertyIsEnumerable.call(n,r))&&Ae(e,i)}}}function Ae(e,t,n=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&ge(t,n)}function je(e,t){let n=Array.isArray(e),r={type_:n?1:0,scope_:t?t.scope_:be(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},i=r,a=Me;n&&(i=[r],a=N);let{revoke:o,proxy:s}=Proxy.revocable(i,a);return r.draft_=s,r.revoke_=o,s}var Me={get(e,t){if(t===v)return e;let n=O(e);if(!T(n,t))return Pe(e,n,t);let r=n[t];return e.finalized_||!S(r)?r:r===Ne(e.base_,t)?(Le(e),e.copy_[t]=ze(r,e)):r},has(e,t){return t in O(e)},ownKeys(e){return Reflect.ownKeys(O(e))},set(e,t,n){let r=Fe(O(e),t);if(r?.set)return r.set.call(e.draft_,n),!0;if(!e.modified_){let r=Ne(O(e),t),i=r?.[v];if(i&&i.base_===n)return e.copy_[t]=n,e.assigned_[t]=!1,!0;if(me(n,r)&&(n!==void 0||T(e.base_,t)))return!0;Le(e),Ie(e)}return e.copy_[t]===n&&(n!==void 0||t in e.copy_)||Number.isNaN(n)&&Number.isNaN(e.copy_[t])?!0:(e.copy_[t]=n,e.assigned_[t]=!0,!0)},deleteProperty(e,t){return Ne(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,Le(e),Ie(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){let n=O(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r&&{writable:!0,configurable:e.type_!==1||t!==`length`,enumerable:r.enumerable,value:n[t]}},defineProperty(){y(11)},getPrototypeOf(e){return b(e.base_)},setPrototypeOf(){y(12)}},N={};C(Me,(e,t)=>{N[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),N.deleteProperty=function(e,t){return N.set.call(this,e,t,void 0)},N.set=function(e,t,n){return Me.set.call(this,e[0],t,n,e[0])};function Ne(e,t){let n=e[v];return(n?O(n):e)[t]}function Pe(e,t,n){let r=Fe(t,n);return r?`value`in r?r.value:r.get?.call(e.draft_):void 0}function Fe(e,t){if(!(t in e))return;let n=b(e);for(;n;){let e=Object.getOwnPropertyDescriptor(n,t);if(e)return e;n=b(n)}}function Ie(e){e.modified_||(e.modified_=!0,e.parent_&&Ie(e.parent_))}function Le(e){e.copy_||=he(e.base_,e.scope_.immer_.useStrictShallowCopy_)}var Re=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,n)=>{if(typeof e==`function`&&typeof t!=`function`){let n=t;t=e;let r=this;return function(e=n,...i){return r.produce(e,e=>t.call(this,e,...i))}}typeof t!=`function`&&y(6),n!==void 0&&typeof n!=`function`&&y(7);let r;if(S(e)){let i=Te(this),a=ze(e,void 0),o=!0;try{r=t(a),o=!1}finally{o?Ce(i):we(i)}return Se(i,n),De(r,i)}else if(!e||typeof e!=`object`){if(r=t(e),r===void 0&&(r=e),r===ce&&(r=void 0),this.autoFreeze_&&ge(r,!0),n){let t=[],i=[];j(`Patches`).generateReplacementPatches_(e,r,t,i),n(t,i)}return r}else y(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e==`function`)return(t,...n)=>this.produceWithPatches(t,t=>e(t,...n));let n,r;return[this.produce(e,t,(e,t)=>{n=e,r=t}),n,r]},typeof e?.autoFreeze==`boolean`&&this.setAutoFreeze(e.autoFreeze),typeof e?.useStrictShallowCopy==`boolean`&&this.setUseStrictShallowCopy(e.useStrictShallowCopy),typeof e?.useStrictIteration==`boolean`&&this.setUseStrictIteration(e.useStrictIteration)}createDraft(e){S(e)||y(8),x(e)&&(e=Be(e));let t=Te(this),n=ze(e,void 0);return n[v].isManual_=!0,we(t),n}finishDraft(e,t){let n=e&&e[v];(!n||!n.isManual_)&&y(9);let{scope_:r}=n;return Se(r,t),De(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}setUseStrictIteration(e){this.useStrictIteration_=e}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(e,t){let n;for(n=t.length-1;n>=0;n--){let r=t[n];if(r.path.length===0&&r.op===`replace`){e=r.value;break}}n>-1&&(t=t.slice(n+1));let r=j(`Patches`).applyPatches_;return x(e)?r(e,t):this.produce(e,e=>r(e,t))}};function ze(e,t){let n=E(e)?j(`MapSet`).proxyMap_(e,t):D(e)?j(`MapSet`).proxySet_(e,t):je(e,t);return(t?t.scope_:be()).drafts_.push(n),n}function Be(e){return x(e)||y(10,e),Ve(e)}function Ve(e){if(!S(e)||A(e))return e;let t=e[v],n,r=!0;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,n=he(e,t.scope_.immer_.useStrictShallowCopy_),r=t.scope_.immer_.shouldUseStrictIteration()}else n=he(e,!0);return C(n,(e,t)=>{pe(n,e,Ve(t))},r),t&&(t.finalized_=!1),n}function He(){let e=`replace`,t=`remove`;function n(e,t,n,o){switch(e.type_){case 0:case 2:return i(e,t,n,o);case 1:return r(e,t,n,o);case 3:return a(e,t,n,o)}}function r(n,r,i,a){let{base_:o,assigned_:s}=n,c=n.copy_;c.length<o.length&&([o,c]=[c,o],[i,a]=[a,i]);for(let t=0;t<o.length;t++)if(s[t]&&c[t]!==o[t]){let n=r.concat([t]);i.push({op:e,path:n,value:l(c[t])}),a.push({op:e,path:n,value:l(o[t])})}for(let e=o.length;e<c.length;e++){let t=r.concat([e]);i.push({op:`add`,path:t,value:l(c[e])})}for(let e=c.length-1;o.length<=e;--e){let n=r.concat([e]);a.push({op:t,path:n})}}function i(n,r,i,a){let{base_:o,copy_:s}=n;C(n.assigned_,(n,c)=>{let u=fe(o,n),d=fe(s,n),f=c?T(o,n)?e:`add`:t;if(u===d&&f===e)return;let p=r.concat(n);i.push(f===t?{op:f,path:p}:{op:f,path:p,value:d}),a.push(f===`add`?{op:t,path:p}:f===t?{op:`add`,path:p,value:l(u)}:{op:e,path:p,value:l(u)})})}function a(e,n,r,i){let{base_:a,copy_:o}=e,s=0;a.forEach(e=>{if(!o.has(e)){let a=n.concat([s]);r.push({op:t,path:a,value:e}),i.unshift({op:`add`,path:a,value:e})}s++}),s=0,o.forEach(e=>{if(!a.has(e)){let a=n.concat([s]);r.push({op:`add`,path:a,value:e}),i.unshift({op:t,path:a,value:e})}s++})}function o(t,n,r,i){r.push({op:e,path:[],value:n===ce?void 0:n}),i.push({op:e,path:[],value:t})}function s(n,r){return r.forEach(r=>{let{path:i,op:a}=r,o=n;for(let e=0;e<i.length-1;e++){let t=w(o),n=i[e];typeof n!=`string`&&typeof n!=`number`&&(n=``+n),(t===0||t===1)&&(n===`__proto__`||n===`constructor`)&&y(19),typeof o==`function`&&n===`prototype`&&y(19),o=fe(o,n),typeof o!=`object`&&y(18,i.join(`/`))}let s=w(o),l=c(r.value),u=i[i.length-1];switch(a){case e:switch(s){case 2:return o.set(u,l);case 3:y(16);default:return o[u]=l}case`add`:switch(s){case 1:return u===`-`?o.push(l):o.splice(u,0,l);case 2:return o.set(u,l);case 3:return o.add(l);default:return o[u]=l}case t:switch(s){case 1:return o.splice(u,1);case 2:return o.delete(u);case 3:return o.delete(r.value);default:return delete o[u]}default:y(17,a)}}),n}function c(e){if(!S(e))return e;if(Array.isArray(e))return e.map(c);if(E(e))return new Map(Array.from(e.entries()).map(([e,t])=>[e,c(t)]));if(D(e))return new Set(Array.from(e).map(c));let t=Object.create(b(e));for(let n in e)t[n]=c(e[n]);return T(e,_)&&(t[_]=e[_]),t}function l(e){return x(e)?c(e):e}ye(`Patches`,{applyPatches_:s,generatePatches_:n,generateReplacementPatches_:o})}var Ue=new Re;Ue.produce;var We=Ue.produceWithPatches.bind(Ue),P=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};He();var Ge=class{constructor(e){this.messageBus=e}getItems(e){return P(this,void 0,void 0,function*(){if(Array.isArray(e)){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_GET_ITEMS`,{ids:e});return t}else if(e){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_GET_ALL_ITEMS`,{});return t.filter(e)}else{let{items:e}=yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_GET_ALL_ITEMS`,{});return e}})}isItemArray(e){return Array.isArray(e)&&e.every(e=>typeof e!=`string`)}updateItems(e,t){return P(this,void 0,void 0,function*(){let n;n=this.isItemArray(e)?e:yield this.getItems(e);let[r,i]=We(n,t),a=r.map(e=>({id:e.id,type:e.type}));for(let e of i){let[t,n]=e.path;typeof t==`number`&&typeof n==`string`&&(a[t][n]=r[t][n])}let o=a.filter(e=>Object.keys(e).length>2);o.length!==0&&(yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_UPDATE_ITEMS`,{updates:o}))})}addItems(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_ADD_ITEMS`,{items:e})})}deleteItems(e){return P(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_DELETE_ITEMS`,{ids:e})})}getItemAttachments(e){return P(this,void 0,void 0,function*(){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS`,{ids:e});return t})}getItemBounds(e){return P(this,void 0,void 0,function*(){let{bounds:t}=yield this.messageBus.sendAsync(`OBR_SCENE_ITEMS_GET_ITEM_BOUNDS`,{ids:e});return t})}onChange(e){let t=t=>{e(t.items)};return this.messageBus.send(`OBR_SCENE_ITEMS_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_ITEMS_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_ITEMS_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_ITEMS_EVENT_CHANGE`,t)}}},F=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};He();var Ke=class{constructor(e){this.messageBus=e}getItems(e){return F(this,void 0,void 0,function*(){if(Array.isArray(e)){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_GET_ITEMS`,{ids:e});return t}else if(e){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_GET_ALL_ITEMS`,{});return t.filter(e)}else{let{items:e}=yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_GET_ALL_ITEMS`,{});return e}})}isItemArray(e){return Array.isArray(e)&&e.every(e=>typeof e!=`string`)}updateItems(e,t,n){return F(this,void 0,void 0,function*(){let r;r=this.isItemArray(e)?e:yield this.getItems(e);let[i,a]=We(r,t),o=i.map(e=>({id:e.id,type:e.type}));for(let e of a){let[t,n]=e.path;typeof t==`number`&&typeof n==`string`&&(o[t][n]=i[t][n])}let s=o.filter(e=>Object.keys(e).length>2);s.length!==0&&(yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_UPDATE_ITEMS`,{updates:s,fastUpdate:n}))})}addItems(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_ADD_ITEMS`,{items:e})})}deleteItems(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_DELETE_ITEMS`,{ids:e})})}getItemAttachments(e){return F(this,void 0,void 0,function*(){let{items:t}=yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS`,{ids:e});return t})}getItemBounds(e){return F(this,void 0,void 0,function*(){let{bounds:t}=yield this.messageBus.sendAsync(`OBR_SCENE_LOCAL_GET_ITEM_BOUNDS`,{ids:e});return t})}onChange(e){let t=t=>{e(t.items)};return this.messageBus.send(`OBR_SCENE_LOCAL_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_LOCAL_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_LOCAL_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_LOCAL_EVENT_CHANGE`,t)}}},qe=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},Je=class{constructor(e){this.messageBus=e,this.grid=new oe(e),this.fog=new ae(e),this.history=new se(e),this.items=new Ge(e),this.local=new Ke(e)}isReady(){return qe(this,void 0,void 0,function*(){let{ready:e}=yield this.messageBus.sendAsync(`OBR_SCENE_IS_READY`,{});return e})}onReadyChange(e){let t=t=>{e(t.ready)};return this.messageBus.send(`OBR_SCENE_READY_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_EVENT_READY_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_READY_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_EVENT_READY_CHANGE`,t)}}getMetadata(){return qe(this,void 0,void 0,function*(){let{metadata:e}=yield this.messageBus.sendAsync(`OBR_SCENE_GET_METADATA`,{});return e})}setMetadata(e){return qe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_SCENE_SET_METADATA`,{update:e})})}onMetadataChange(e){let t=t=>{e(t.metadata)};return this.messageBus.send(`OBR_SCENE_METADATA_SUBSCRIBE`,{}),this.messageBus.on(`OBR_SCENE_METADATA_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_SCENE_METADATA_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_SCENE_METADATA_EVENT_CHANGE`,t)}}};function Ye(e){return e.startsWith(`http`)?e:`${window.location.origin}${e}`}function I(e){return e.map(e=>Object.assign(Object.assign({},e),{icon:Ye(e.icon)}))}function Xe(e){return Object.assign(Object.assign({},e),{url:Ye(e.url)})}var Ze=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},Qe=class{constructor(e){this.contextMenus={},this.handleClick=e=>{var t;let n=this.contextMenus[e.id];n&&((t=n.onClick)==null||t.call(n,e.context,e.elementId))},this.messageBus=e,e.on(`OBR_CONTEXT_MENU_EVENT_CLICK`,this.handleClick)}create(e){return Ze(this,void 0,void 0,function*(){this.messageBus.sendAsync(`OBR_CONTEXT_MENU_CREATE`,{id:e.id,shortcut:e.shortcut,icons:I(e.icons),embed:e.embed&&Xe(e.embed)}),this.contextMenus[e.id]=e})}remove(e){return Ze(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_CONTEXT_MENU_REMOVE`,{id:e}),delete this.contextMenus[e]})}},L=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},$e=class{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=e=>{let t=this.tools[e.id];if(t)if(t.onClick){let n=t.onClick(e.context,e.elementId);Promise.resolve(n).then(t=>{t&&this.messageBus.send(`OBR_TOOL_ACTIVATE`,{id:e.id})})}else this.messageBus.send(`OBR_TOOL_ACTIVATE`,{id:e.id})},this.handleToolActionClick=e=>{var t;let n=this.toolActions[e.id];n&&((t=n.onClick)==null||t.call(n,e.context,e.elementId))},this.handleToolModeClick=e=>{let t=this.toolModes[e.id];if(t)if(t.onClick){let n=t.onClick(e.context,e.elementId);Promise.resolve(n).then(t=>{t&&this.messageBus.send(`OBR_TOOL_MODE_ACTIVATE`,{toolId:e.context.activeTool,modeId:e.id})})}else this.messageBus.send(`OBR_TOOL_MODE_ACTIVATE`,{toolId:e.context.activeTool,modeId:e.id})},this.handleToolModeToolClick=e=>{let t=this.toolModes[e.id];if(t)if(t.onToolClick){let n=t.onToolClick(e.context,e.event);Promise.resolve(n).then(t=>{t&&e.event.target&&!e.event.target.locked&&this.messageBus.sendAsync(`OBR_PLAYER_SELECT`,{items:[e.event.target.id]})})}else e.event.target&&!e.event.target.locked&&this.messageBus.sendAsync(`OBR_PLAYER_SELECT`,{items:[e.event.target.id]})},this.handleToolModeToolDoubleClick=e=>{let t=this.toolModes[e.id];if(t)if(t.onToolDoubleClick){let n=t.onToolDoubleClick(e.context,e.event);Promise.resolve(n).then(t=>{t&&e.event.target&&this.messageBus.sendAsync(`OBR_PLAYER_SELECT`,{items:[e.event.target.id]})})}else e.event.target&&this.messageBus.sendAsync(`OBR_PLAYER_SELECT`,{items:[e.event.target.id]})},this.handleToolModeToolDown=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolDown)==null||t.call(n,e.context,e.event))},this.handleToolModeToolMove=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolMove)==null||t.call(n,e.context,e.event))},this.handleToolModeToolUp=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolUp)==null||t.call(n,e.context,e.event))},this.handleToolModeToolDragStart=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolDragStart)==null||t.call(n,e.context,e.event))},this.handleToolModeToolDragMove=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolDragMove)==null||t.call(n,e.context,e.event))},this.handleToolModeToolDragEnd=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolDragEnd)==null||t.call(n,e.context,e.event))},this.handleToolModeToolDragCancel=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onToolDragCancel)==null||t.call(n,e.context,e.event))},this.handleToolModeKeyDown=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onKeyDown)==null||t.call(n,e.context,e.event))},this.handleToolModeKeyUp=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onKeyUp)==null||t.call(n,e.context,e.event))},this.handleToolModeActivate=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onActivate)==null||t.call(n,e.context))},this.handleToolModeDeactivate=e=>{var t;let n=this.toolModes[e.id];n&&((t=n.onDeactivate)==null||t.call(n,e.context))},this.messageBus=e,e.on(`OBR_TOOL_EVENT_CLICK`,this.handleToolClick),e.on(`OBR_TOOL_ACTION_EVENT_CLICK`,this.handleToolActionClick),e.on(`OBR_TOOL_MODE_EVENT_CLICK`,this.handleToolModeClick),e.on(`OBR_TOOL_MODE_EVENT_TOOL_CLICK`,this.handleToolModeToolClick),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK`,this.handleToolModeToolDoubleClick),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DOWN`,this.handleToolModeToolDown),e.on(`OBR_TOOL_MODE_EVENT_TOOL_MOVE`,this.handleToolModeToolMove),e.on(`OBR_TOOL_MODE_EVENT_TOOL_UP`,this.handleToolModeToolUp),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DRAG_START`,this.handleToolModeToolDragStart),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE`,this.handleToolModeToolDragMove),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DRAG_END`,this.handleToolModeToolDragEnd),e.on(`OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL`,this.handleToolModeToolDragCancel),e.on(`OBR_TOOL_MODE_EVENT_KEY_DOWN`,this.handleToolModeKeyDown),e.on(`OBR_TOOL_MODE_EVENT_KEY_UP`,this.handleToolModeKeyUp),e.on(`OBR_TOOL_MODE_EVENT_ACTIVATE`,this.handleToolModeActivate),e.on(`OBR_TOOL_MODE_EVENT_DEACTIVATE`,this.handleToolModeDeactivate)}create(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_CREATE`,{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:I(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_REMOVE`,{id:e}),delete this.tools[e]})}activateTool(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_ACTIVATE`,{id:e})})}getActiveTool(){return L(this,void 0,void 0,function*(){let{id:e}=yield this.messageBus.sendAsync(`OBR_TOOL_GET_ACTIVE`,{});return e})}onToolChange(e){let t=t=>{e(t.id)};return this.messageBus.send(`OBR_TOOL_ACTIVE_SUBSCRIBE`,{}),this.messageBus.on(`OBR_TOOL_ACTIVE_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_TOOL_ACTIVE_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_TOOL_ACTIVE_EVENT_CHANGE`,t)}}getMetadata(e){return L(this,void 0,void 0,function*(){let{metadata:t}=yield this.messageBus.sendAsync(`OBR_TOOL_GET_METADATA`,{id:e});return t})}setMetadata(e,t){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_SET_METADATA`,{toolId:e,update:t})})}createAction(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_ACTION_CREATE`,{id:e.id,shortcut:e.shortcut,icons:I(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_ACTION_REMOVE`,{id:e}),delete this.tools[e]})}createMode(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_MODE_CREATE`,{id:e.id,shortcut:e.shortcut,icons:I(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_MODE_REMOVE`,{id:e}),delete this.tools[e]})}activateMode(e,t){return L(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_TOOL_MODE_ACTIVATE`,{toolId:e,modeId:t})})}getActiveToolMode(){return L(this,void 0,void 0,function*(){let{id:e}=yield this.messageBus.sendAsync(`OBR_TOOL_MODE_GET_ACTIVE`,{});return e})}onToolModeChange(e){let t=t=>{e(t.id)};return this.messageBus.send(`OBR_TOOL_MODE_ACTIVE_SUBSCRIBE`,{}),this.messageBus.on(`OBR_TOOL_MODE_ACTIVE_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_TOOL_MODE_ACTIVE_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_TOOL_MODE_ACTIVE_EVENT_CHANGE`,t)}}},R=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},et=class{constructor(e){this.messageBus=e}open(e){return R(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_POPOVER_OPEN`,Object.assign({},Xe(e)))})}close(e){return R(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_POPOVER_CLOSE`,{id:e})})}getWidth(e){return R(this,void 0,void 0,function*(){let{width:t}=yield this.messageBus.sendAsync(`OBR_POPOVER_GET_WIDTH`,{id:e});return t})}setWidth(e,t){return R(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_POPOVER_SET_WIDTH`,{id:e,width:t})})}getHeight(e){return R(this,void 0,void 0,function*(){let{height:t}=yield this.messageBus.sendAsync(`OBR_POPOVER_GET_HEIGHT`,{id:e});return t})}setHeight(e,t){return R(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_POPOVER_SET_HEIGHT`,{id:e,height:t})})}},tt=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},nt=class{constructor(e){this.messageBus=e}open(e){return tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_MODAL_OPEN`,Object.assign({},Xe(e)))})}close(e){return tt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_MODAL_CLOSE`,{id:e})})}},z=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},rt=class{constructor(e){this.messageBus=e}getWidth(){return z(this,void 0,void 0,function*(){let{width:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_WIDTH`,{});return e})}setWidth(e){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_SET_WIDTH`,{width:e})})}getHeight(){return z(this,void 0,void 0,function*(){let{height:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_HEIGHT`,{});return e})}setHeight(e){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_SET_HEIGHT`,{height:e})})}getBadgeText(){return z(this,void 0,void 0,function*(){let{badgeText:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_BADGE_TEXT`,{});return e})}setBadgeText(e){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_SET_BADGE_TEXT`,{badgeText:e})})}getBadgeBackgroundColor(){return z(this,void 0,void 0,function*(){let{badgeBackgroundColor:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_BADGE_BACKGROUND_COLOR`,{});return e})}setBadgeBackgroundColor(e){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_SET_BADGE_BACKGROUND_COLOR`,{badgeBackgroundColor:e})})}getIcon(){return z(this,void 0,void 0,function*(){let{icon:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_ICON`,{});return e})}setIcon(e){return z(this,void 0,void 0,function*(){let t=I([{icon:e}]);yield this.messageBus.sendAsync(`OBR_ACTION_SET_ICON`,{icon:t[0].icon})})}getTitle(){return z(this,void 0,void 0,function*(){let{title:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_TITLE`,{});return e})}setTitle(e){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_SET_TITLE`,{title:e})})}isOpen(){return z(this,void 0,void 0,function*(){let{isOpen:e}=yield this.messageBus.sendAsync(`OBR_ACTION_GET_IS_OPEN`,{});return e})}open(){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_OPEN`,{})})}close(){return z(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ACTION_CLOSE`,{})})}onOpenChange(e){let t=t=>{e(t.isOpen)};return this.messageBus.send(`OBR_ACTION_IS_OPEN_SUBSCRIBE`,{}),this.messageBus.on(`OBR_ACTION_IS_OPEN_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_IS_OPEN_ACTION_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_ACTION_IS_OPEN_EVENT_CHANGE`,t)}}},it=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})};He();var at=class{constructor(e){this.messageBus=e}startItemInteraction(e){return it(this,void 0,void 0,function*(){let{id:t}=yield this.messageBus.sendAsync(`OBR_INTERACTION_START_ITEM_INTERACTION`,{baseState:e}),n=e;return[e=>{let[r,i]=We(n,e);return n=r,this.messageBus.send(`OBR_INTERACTION_UPDATE_ITEM_INTERACTION`,{id:t,patches:i}),r},()=>{this.messageBus.send(`OBR_INTERACTION_STOP_ITEM_INTERACTION`,{id:t})}]})}},ot=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},st=class{constructor(e){this.messageBus=e}getPlayers(){return ot(this,void 0,void 0,function*(){let{players:e}=yield this.messageBus.sendAsync(`OBR_PARTY_GET_PLAYERS`,{});return e})}onChange(e){let t=t=>{e(t.players)};return this.messageBus.send(`OBR_PARTY_SUBSCRIBE`,{}),this.messageBus.on(`OBR_PARTY_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_PARTY_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_PARTY_EVENT_CHANGE`,t)}}},ct=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},lt=class{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return ct(this,void 0,void 0,function*(){let{permissions:e}=yield this.messageBus.sendAsync(`OBR_ROOM_GET_PERMISSIONS`,{});return e})}getMetadata(){return ct(this,void 0,void 0,function*(){let{metadata:e}=yield this.messageBus.sendAsync(`OBR_ROOM_GET_METADATA`,{});return e})}setMetadata(e){return ct(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ROOM_SET_METADATA`,{update:e})})}onMetadataChange(e){let t=t=>{e(t.metadata)};return this.messageBus.send(`OBR_ROOM_METADATA_SUBSCRIBE`,{}),this.messageBus.on(`OBR_ROOM_METADATA_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_METADATA_ROOM_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_ROOM_METADATA_EVENT_CHANGE`,t)}}onPermissionsChange(e){let t=t=>{e(t.permissions)};return this.messageBus.send(`OBR_ROOM_PERMISSIONS_SUBSCRIBE`,{}),this.messageBus.on(`OBR_ROOM_PERMISSIONS_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_PERMISSIONS_ROOM_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_ROOM_PERMISSIONS_EVENT_CHANGE`,t)}}},ut=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},dt=class{constructor(e){this.messageBus=e}getTheme(){return ut(this,void 0,void 0,function*(){let{theme:e}=yield this.messageBus.sendAsync(`OBR_THEME_GET_THEME`,{});return e})}onChange(e){let t=t=>{e(t.theme)};return this.messageBus.send(`OBR_THEME_SUBSCRIBE`,{}),this.messageBus.on(`OBR_THEME_EVENT_CHANGE`,t),()=>{this.messageBus.send(`OBR_THEME_UNSUBSCRIBE`,{}),this.messageBus.off(`OBR_THEME_EVENT_CHANGE`,t)}}},B=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},ft=class{constructor(e){this.messageBus=e}uploadImages(e,t){return B(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ASSETS_UPLOAD_IMAGES`,{images:e,typeHint:t})})}uploadScenes(e,t){return B(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_ASSETS_UPLOAD_SCENES`,{scenes:e,disableShowScenes:t})})}downloadImages(e,t,n){return B(this,void 0,void 0,function*(){let{images:r}=yield this.messageBus.sendAsync(`OBR_ASSETS_DOWNLOAD_IMAGES`,{multiple:e,defaultSearch:t,typeHint:n},-1);return r})}downloadScenes(e,t){return B(this,void 0,void 0,function*(){let{scenes:n}=yield this.messageBus.sendAsync(`OBR_ASSETS_DOWNLOAD_SCENES`,{multiple:e,defaultSearch:t},-1);return n})}},pt=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},mt=class{constructor(e){this.messageBus=e}sendMessage(e,t,n){return pt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync(`OBR_BROADCAST_SEND_MESSAGE`,{channel:e,data:t,options:n})})}onMessage(e,t){return this.messageBus.send(`OBR_BROADCAST_SUBSCRIBE`,{channel:e}),this.messageBus.on(`OBR_BROADCAST_MESSAGE_${e}`,t),()=>{this.messageBus.send(`OBR_BROADCAST_UNSUBSCRIBE`,{channel:e}),this.messageBus.off(`OBR_BROADCAST_MESSAGE_${e}`,t)}}},ht=typeof Buffer==`function`,gt=typeof TextDecoder==`function`?new TextDecoder:void 0;typeof TextEncoder==`function`&&new TextEncoder;var V=(e=>{let t={};return e.forEach((e,n)=>t[e]=n),t})(Array.prototype.slice.call(`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=`)),_t=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,H=String.fromCharCode.bind(String),vt=typeof Uint8Array.from==`function`?Uint8Array.from.bind(Uint8Array):e=>new Uint8Array(Array.prototype.slice.call(e,0)),yt=e=>e.replace(/[^A-Za-z0-9\+\/]/g,``),bt=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,xt=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return H((t>>>10)+55296)+H((t&1023)+56320);case 3:return H((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return H((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},St=e=>e.replace(bt,xt),Ct=typeof atob==`function`?e=>atob(yt(e)):ht?e=>Buffer.from(e,`base64`).toString(`binary`):e=>{if(e=e.replace(/\s+/g,``),!_t.test(e))throw TypeError(`malformed base64.`);e+=`==`.slice(2-(e.length&3));let t,n,r,i=[];for(let a=0;a<e.length;)t=V[e.charAt(a++)]<<18|V[e.charAt(a++)]<<12|(n=V[e.charAt(a++)])<<6|(r=V[e.charAt(a++)]),n===64?i.push(H(t>>16&255)):r===64?i.push(H(t>>16&255,t>>8&255)):i.push(H(t>>16&255,t>>8&255,t&255));return i.join(``)},wt=ht?e=>vt(Buffer.from(e,`base64`)):e=>vt(Ct(e).split(``).map(e=>e.charCodeAt(0))),Tt=ht?e=>Buffer.from(e,`base64`).toString(`utf8`):gt?e=>gt.decode(wt(e)):e=>St(Ct(e)),Et=e=>yt(e.replace(/[-_]/g,e=>e==`-`?`+`:`/`)),Dt=e=>Tt(Et(e));function Ot(){let e=new URLSearchParams(window.location.search).get(`obrref`),t=``,n=``;if(e){let r=Dt(e).split(` `);r.length===2&&(t=r[0],n=r[1])}return{origin:t,roomId:n}}var kt;(function(e){e[e.MOVE=0]=`MOVE`,e[e.LINE=1]=`LINE`,e[e.QUAD=2]=`QUAD`,e[e.CONIC=3]=`CONIC`,e[e.CUBIC=4]=`CUBIC`,e[e.CLOSE=5]=`CLOSE`})(kt||={});var At=Ot(),U=new ne(At.origin,At.roomId),W={onReady:e=>{U.ready?e():U.once(`OBR_READY`,()=>e())},get isReady(){return U.ready},viewport:new i(U),player:new n(U),party:new st(U),notification:new ie(U),scene:new Je(U),contextMenu:new Qe(U),tool:new $e(U),popover:new et(U),modal:new nt(U),action:new rt(U),interaction:new at(U),room:new lt(U),theme:new dt(U),assets:new ft(U),broadcast:new mt(U),isAvailable:!!At.origin},G=`com.saimon.video-sync`,jt=`video-player-modal`,Mt=``;document.querySelector(`#app`).innerHTML=`
  <div class="shell">
    <h1> Player de Vdeo Global</h1>
    <p class="subtitle">Carregue um vdeo local e reproduza em tela grande.</p>

    <div class="panel">
      <label for="file">Arquivo de vdeo (local)</label>
      <input id="file" type="file" accept="video/*">
      <div class="actions">
        <button id="btnPlay" disabled>Play em Tela Grande</button>
        <button id="btnStop" class="secondary" disabled>Parar</button>
      </div>
      <div id="status" class="status">Aguardando SDK...</div>
      <div id="roleInfo" class="role-info"></div>
    </div>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button class="close-btn" id="closeOverlay">Fechar</button>
    <button class="play-interaction" id="playInteraction"> Clique para Assistir (Com Som)</button>
    <video id="video" playsinline muted preload="auto"></video>
  </div>

  <div id="ngrokBackdrop" class="ngrok-backdrop" aria-hidden="true"></div>
  <div id="ngrokPopup" class="ngrok-popup" aria-hidden="true">
    <h2>Gostaria de usar a extenso exclusiva do nosso rpg?</h2>
    <p>Para liberar o acesso, abra o link do servidor e clique em "Visit Site".</p>
    <div class="ngrok-actions">
      <button id="ngrokOpen">Abrir link</button>
      <button id="ngrokReload" class="secondary">Recarregar</button>
      <button id="ngrokDismiss" class="secondary">Agora no</button>
    </div>
  </div>
`;var K=document.getElementById(`file`),Nt=document.getElementById(`btnPlay`),Pt=document.getElementById(`btnStop`),Ft=document.getElementById(`status`),It=document.getElementById(`roleInfo`),Lt=document.getElementById(`overlay`),q=document.getElementById(`video`),Rt=document.getElementById(`closeOverlay`);document.getElementById(`playInteraction`);var J=document.getElementById(`ngrokBackdrop`),zt=document.getElementById(`ngrokPopup`),Bt=document.getElementById(`ngrokOpen`),Vt=document.getElementById(`ngrokReload`),Ht=document.getElementById(`ngrokDismiss`),Ut=null,Y=!1,X=null,Wt=``,Z=!1,Q=0,Gt=``,Kt=!1,qt=0,$=e=>{Ft.textContent=e},Jt=()=>{J.style.display=`block`,zt.style.display=`block`,J.setAttribute(`aria-hidden`,`false`),zt.setAttribute(`aria-hidden`,`false`)},Yt=()=>{J.style.display=`none`,zt.style.display=`none`,J.setAttribute(`aria-hidden`,`true`),zt.setAttribute(`aria-hidden`,`true`)},Xt=async()=>{if(localStorage.getItem(`ngrok-visit-site-confirmed`)!==`true`)try{let e=await(await fetch(`${window.location.origin}/`,{credentials:`include`,cache:`no-store`})).text();/ngrok/i.test(e)&&/visit site|browser warning|continue/i.test(e)&&Jt()}catch(e){console.warn(` Falha ao verificar aviso do ngrok:`,e)}};Bt?.addEventListener(`click`,()=>{window.open(window.location.origin,`_blank`,`noopener`),localStorage.setItem(`ngrok-visit-site-confirmed`,`true`)}),Vt?.addEventListener(`click`,()=>{window.location.reload()}),Ht?.addEventListener(`click`,()=>{Yt()});var Zt=()=>{Z=!1,q.pause(),q.removeAttribute(`src`),q.load(),Ut&&=(URL.revokeObjectURL(Ut),null),Lt.style.display=`none`,Lt.setAttribute(`aria-hidden`,`true`),Nt.disabled=!K.files.length,Pt.disabled=!0},Qt=async(e=null)=>{try{console.log(` Abrindo modal para todos...`);let t=e?`/modal.html?video=${encodeURIComponent(e)}`:`/modal.html`;await W.modal.open({id:jt,url:t,fullScreen:!0,disablePointerEvents:!1}),Kt=!0,console.log(` Modal aberto com URL:`,t)}catch(e){console.warn(`No foi possvel abrir modal:`,e)}};K.addEventListener(`change`,async()=>{Zt();let e=K.files?.[0];if(!e){$(`Selecione um arquivo de vdeo.`);return}$(` Enviando vdeo ao servidor...`);let t=new FormData;t.append(`video`,e);try{let n=await fetch(`${Mt}/api/video-upload`,{method:`POST`,body:t});if(!n.ok)throw Error(`Erro no servidor: ${n.status}`);X=(await n.json()).videoUrl,Wt=e.name,Ut=URL.createObjectURL(e),q.src=Ut,Nt.disabled=!Y,$(` Pronto: ${e.name} (${(e.size/1024/1024).toFixed(1)} MB)`),console.log(` URL do vdeo: ${X}`)}catch(e){console.error(`Erro ao enviar:`,e),$(` Erro ao enviar: ${e.message}`)}}),Nt.addEventListener(`click`,async()=>{if(!Y){$(` Apenas o mestre pode controlar o vdeo.`);return}if(!X){$(`Selecione um vdeo antes de tocar.`);return}Lt.style.display=`flex`,Lt.setAttribute(`aria-hidden`,`false`),Pt.disabled=!1,await Qt(X),console.log(` Aguardando modal carregar (3s)...`),await new Promise(e=>setTimeout(e,3e3));try{let e=`${Mt}${X}`;console.log(` Enviando comando de play com URL: ${e}`),await W.broadcast.sendMessage(G,{action:`play`,videoUrl:e,videoName:Wt,timestamp:0},{destination:`ALL`}),$(` Transmitindo comando para todos os jogadores...`)}catch(e){console.error(`Erro ao transmitir:`,e),$(`Erro ao transmitir comando.`)}});var $t=()=>{Y&&Z&&(Z=!1,W.broadcast.sendMessage(G,{action:`stop`},{destination:`ALL`}).catch(e=>console.error(`Erro ao parar:`,e)))};Pt.addEventListener(`click`,()=>{if(!Y){$(` Apenas o mestre pode parar o vdeo.`);return}$t()}),Rt.addEventListener(`click`,()=>{if(!Y){$(` Apenas o mestre pode fechar o vdeo.`);return}$t()}),q.addEventListener(`ended`,()=>{Y&&$t()}),window.addEventListener(`beforeunload`,()=>{Zt()});var en=()=>{W.broadcast.onMessage(G,async e=>{let{action:t,videoUrl:n,videoName:r,timestamp:i}=e.data;if(console.log(` Recebido comando:`,t,n),t===`play`&&n){let e=Date.now();if(e-Q<500){console.log(`  Ignorando comando duplicado (debounce)`);return}if(Q=e,Z&&Gt===n){console.log(`  J est tocando este vdeo, ignorando`);return}Z=!0,Gt=n,await Qt(n),$(` Modal aberto, transmitindo vdeo...`)}else if(t===`stop`){let e=Date.now();if(e-Q<300){console.log(`  Ignorando stop duplicado (debounce)`);return}Q=e,Z=!1,Gt=``,Kt=!1,Zt(),$(Y?`Vdeo parado.`:`O mestre parou o vdeo.`)}else if(t===`state-response`&&!Y){let{videoUrl:t,isPlaying:n}=e.data;n&&t&&!Kt&&(console.log(` Estado ativo detectado, abrindo modal para o player`),await Qt(t))}})};W.onReady(async()=>{console.log(`OWLbear SDK pronto!`),Xt();let e=await W.player.getRole();if(Y=e===`GM`,Y?(It.textContent=` Voc  o Mestre - Controles habilitados`,It.style.color=`#4CAF50`,K.disabled=!1,$(`Selecione um arquivo de vdeo.`)):(It.textContent=` Voc  um Jogador - Aguardando comandos do mestre`,It.style.color=`#FF9800`,K.disabled=!0,Nt.disabled=!0,$(`Aguardando o mestre iniciar o vdeo...`)),en(),!Y){let e=async()=>{if(!(qt>=6)){qt+=1;try{await W.broadcast.sendMessage(G,{action:`state-request`})}catch(e){console.warn(` Falha ao solicitar estado:`,e)}setTimeout(e,1200)}};e()}console.log(` Iniciado como: ${e}`)});